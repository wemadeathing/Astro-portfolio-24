---
interface Props {
  href: string;
  title: string;
  description?: string;
  image?: string;
  siteName?: string;
  type?: string;
  tags?: string[];
  index?: number;
}

const { href, title, description, image, siteName, type = 'other', tags = [], index = 0 } = Astro.props;

// Cap animation delay at 600ms for performance
const animationDelay = `${Math.min(index * 40, 600)}ms`;

const normalizeType = (t: unknown) => String(t || '').toLowerCase().trim();
const typeLabel = (t: unknown) => {
  const kind = normalizeType(t);
  if (!kind || kind === 'other') return 'Resource';
  if (kind === 'library') return 'Library';
  if (kind === 'directory') return 'Directory';
  if (kind === 'tool') return 'Tool';
  if (kind === 'article') return 'Article';
  if (kind === 'video') return 'Video';
  if (kind === 'template') return 'Template';
  if (kind === 'course') return 'Course';
  if (kind === 'podcast') return 'Podcast';
  if (kind === 'newsletter') return 'Newsletter';
  if (kind === 'book') return 'Book';
  return kind.charAt(0).toUpperCase() + kind.slice(1);
};

const searchText = `${title} ${description ?? ''} ${siteName ?? ''} ${href}`
  .toLowerCase()
  .replace(/\s+/g, ' ')
  .trim();

// Normalize tags for exact matching
const normalizedTags = tags.map(t => String(t).toLowerCase().replace(/[^a-z0-9]/g, '-'));

const typeIconPaths = (t: unknown) => {
  const kind = normalizeType(t || 'other');

  // Stroke-only icon paths (stable + consistent rendering)
  if (kind === 'video') {
    return ['M10 8.5v7l6-3.5-6-3.5Z'];
  }

  if (kind === 'article' || kind === 'paper') {
    return ['M8 4h8v16H8z', 'M10 8h4', 'M10 11h4', 'M10 14h3'];
  }

  if (kind === 'tool') {
    return ['M14.7 6.3a3.5 3.5 0 0 1-4.9 4.9L6 15v3h3l3.8-3.8a3.5 3.5 0 0 1 4.9-4.9L16 8l-1.3-1.7Z'];
  }

  if (kind === 'library') {
    // bookshelf
    return ['M5 6h14', 'M5 18h14', 'M7 6v12', 'M11 6v12', 'M15 6v12'];
  }

  if (kind === 'directory') {
    // list
    return ['M7 6h14', 'M7 12h14', 'M7 18h14', 'M3 6h2', 'M3 12h2', 'M3 18h2'];
  }

  if (kind === 'course') {
    // graduation cap
    return ['M22 10L12 5 2 10l10 5 10-5Z', 'M6 12v5c0 1.7 2.7 3 6 3s6-1.3 6-3v-5'];
  }

  if (kind === 'podcast') {
    return ['M12 3a7 7 0 0 0-7 7v3a3 3 0 0 0 3 3h1v-6H8a4 4 0 1 1 8 0h-1v6h1a3 3 0 0 0 3-3v-3a7 7 0 0 0-7-7Z'];
  }

  if (kind === 'newsletter') {
    return ['M4 4h16v16H4z', 'm4 7 8 5 8-5'];
  }

  if (kind === 'book') {
    return ['M6 4h12v16H6z', 'M10 4v16'];
  }

  if (kind === 'docs') {
    return ['M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z', 'M14 2v6h6', 'M16 13H8', 'M16 17H8', 'M10 9H8'];
  }

  if (kind === 'platform') {
    return ['M12 2L2 7l10 5 10-5-10-5z', 'M2 17l10 5 10-5', 'M2 12l10 5 10-5'];
  }

  if (kind === 'template') {
    return ['M4 4h16v16H4z', 'M4 9h16', 'M9 9v11'];
  }

  // other
  return ['M6 8h12', 'M6 12h12', 'M6 16h9'];
};
---

<a
  href={href}
  target="_blank"
  rel="noopener noreferrer"
  data-resource-card
  data-search={searchText}
  data-type={normalizeType(type)}
  data-tags={normalizedTags.join(',')}
  style={`animation-delay: ${animationDelay}`}
  class="group relative flex flex-col justify-between overflow-hidden rounded-2xl border border-white/10 bg-white/[0.03] transition-all hover:bg-white/[0.05] hover:border-white/20 focus:outline-none focus-visible:ring-4 focus-visible:ring-primary/20 h-full"
>
  {/* Image Container */}
  <div class="aspect-[16/10] w-full overflow-hidden bg-white/5 relative">
    {image ? (
      <img
        src={image}
        alt={title}
        class="absolute inset-0 h-full w-full object-cover transition-transform duration-500 group-hover:scale-105"
        loading="lazy"
        decoding="async"
        referrerpolicy="no-referrer"
      />
    ) : (
      <div class="absolute inset-0 flex items-center justify-center bg-gradient-to-br from-white/5 to-white/0">
         <svg
          width="28"
          height="28"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="1.5"
          stroke-linecap="round"
          stroke-linejoin="round"
          class="text-white/20"
          aria-hidden="true"
        >
          {typeIconPaths(type).map((d) => (
            <path d={d} />
          ))}
        </svg>
      </div>
    )}
    
    {/* Type Badge */}
    <div class="absolute left-2.5 top-2.5 inline-flex items-center rounded-full bg-black/60 backdrop-blur-md border border-white/10 px-2 py-0.5 text-[10px] uppercase tracking-wider text-white/70 shadow-sm">
      {typeLabel(type)}
    </div>
  </div>

  <div class="flex flex-1 flex-col p-3 sm:p-4">
    <div>
      <h3 class="text-sm sm:text-base font-semibold text-white/95 group-hover:text-primary transition-colors line-clamp-2 leading-tight">
        {title}
      </h3>

      {description ? (
        <p class="mt-1.5 text-xs sm:text-sm text-white/60 line-clamp-2 leading-relaxed">{description}</p>
      ) : null}
    </div>
    
    <div class="mt-3 flex items-center gap-2 text-xs text-white/40 pt-3 border-t border-white/5">
      {/* Site Name / Origin */}
       {siteName && (
        <span class="truncate hover:text-white/60 transition-colors">
            {siteName}
        </span>
       )}
       {!siteName && (
        <span class="truncate">External Resource</span>
       )}
       
       <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="ml-auto opacity-0 -translate-x-2 group-hover:opacity-100 group-hover:translate-x-0 transition-all text-primary">
        <path d="M7 17L17 7" />
        <path d="M7 7h10v10" />
       </svg>
    </div>
  </div>
</a>
