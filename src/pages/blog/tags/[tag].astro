---
import Layout from '../../../layouts/Layout.astro';
import BlogCard from '../../../components/BlogCard.astro';
import { getCollection } from 'astro:content';
import { readingTime } from '../../../lib/reading-time';
import { slugToTag, tagToSlug } from '../../../lib/tag-utils';

export const prerender = true;

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  const tags = Array.from(
    new Set(
      posts
        .flatMap((p) => p.data.tags ?? [])
        .map((t) => String(t).trim())
        .filter(Boolean)
    )
  ).sort((a, b) => a.localeCompare(b));

  return tags.map((tag) => ({
    params: { tag: tagToSlug(tag) },
    props: { tag },
  }));
}

const activeTag = String(Astro.props.tag || '').trim();

const posts = await getCollection('blog');
const sortedPosts = posts.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

const allTags = Array.from(
  new Set(
    sortedPosts
      .flatMap((p) => p.data.tags ?? [])
      .map((t) => String(t).trim())
      .filter(Boolean)
  )
).sort((a, b) => a.localeCompare(b));

// Safety: if tag is not valid anymore, redirect back.
if (!activeTag || !slugToTag(tagToSlug(activeTag), allTags)) {
  return Astro.redirect('/blog');
}

const filteredPosts = sortedPosts.filter((p) => (p.data.tags ?? []).includes(activeTag));
---

<Layout
  title={`Insights tagged “${activeTag}” | Nasif Salaam`}
  description={`Posts tagged “${activeTag}”: AI workflows, product craft, and the practical side of shipping.`}
>
  <section class="py-10 sm:py-14">
    <div class="container max-w-[1100px] mx-auto px-4 sm:px-6 lg:px-8">
      <div class="max-w-[68ch]">
        <div class="text-xs tracking-[0.22em] uppercase text-white/50">Topic</div>
        <h1 class="mt-3 type-h1 text-white/95">{activeTag}</h1>
        <p class="mt-4 type-lead text-white/70">
          Posts tagged “{activeTag}”.
        </p>
      </div>

      {allTags.length > 0 && (
        <div class="mt-7">
          <div class="flex flex-wrap items-center gap-2 overflow-x-auto pb-1">
            <a
              href="/blog"
              class="inline-flex items-center rounded-full border px-3 py-1.5 text-xs font-semibold transition-colors bg-white/[0.03] text-white/70 border-white/10 hover:bg-white/[0.06] hover:text-white"
            >
              All
            </a>
            {allTags.map((tag) => {
              const isActive = tag === activeTag;
              return (
                <a
                  href={`/blog/tags/${tagToSlug(tag)}`}
                  class:list={[
                    'inline-flex items-center rounded-full border px-3 py-1.5 text-xs font-semibold transition-colors',
                    isActive
                      ? 'bg-primary/15 text-white/90 border-primary/30'
                      : 'bg-white/[0.03] text-white/70 border-white/10 hover:bg-white/[0.06] hover:text-white',
                  ]}
                  aria-current={isActive ? 'true' : undefined}
                >
                  {tag}
                </a>
              );
            })}
          </div>
        </div>
      )}

      <div class="mt-10 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8 md:gap-10 stagger-children">
        {filteredPosts.map((post) => (
          <BlogCard
            title={post.data.title}
            excerpt={post.data.description}
            date={post.data.pubDate}
            image={post.data.image}
            slug={post.slug}
            readingTime={readingTime(post.body).label}
          />
        ))}
      </div>
    </div>
  </section>
</Layout>
