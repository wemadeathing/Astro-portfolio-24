---
import { getCollection, getEntry } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import ShareButtons from '../../components/ShareButtons.astro';
import TableOfContents from '../../components/TableOfContents.astro';
import Breadcrumb from '../../components/Breadcrumb.astro';
import NewsletterForm from '../../components/NewsletterForm.astro';
import BlogCard from '../../components/BlogCard.astro';
import { readingTime } from '../../lib/reading-time';
import { tagToSlug } from '../../lib/tag-utils';
import type { CollectionEntry } from 'astro:content';

export const prerender = true;

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

// For server-side rendering, get the post by slug
const { slug } = Astro.params;
let post: CollectionEntry<'blog'>;

if (Astro.props?.post) {
  // Static generation - use props
  post = Astro.props.post;
} else {
  // Server-side rendering - fetch by slug
  const postEntry = await getEntry('blog', slug!);
  if (!postEntry) {
    return Astro.redirect('/404');
  }
  post = postEntry;
}

const { Content } = await post.render();

const rt = readingTime(post.body);

const formattedDate = post.data.pubDate.toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});

const formattedUpdated = post.data.updatedDate
  ? post.data.updatedDate.toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
    })
  : null;

const allPosts = await getCollection('blog');
const sortedPosts = allPosts.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());
const currentIndex = sortedPosts.findIndex((p) => p.slug === post.slug);
const prevPost = currentIndex > 0 ? sortedPosts[currentIndex - 1] : null;
const nextPost = currentIndex >= 0 && currentIndex < sortedPosts.length - 1 ? sortedPosts[currentIndex + 1] : null;

const overlapScore = (a: string[], b: string[]) => {
  const A = new Set(a.map((x) => String(x).toLowerCase().trim()).filter(Boolean));
  const B = new Set(b.map((x) => String(x).toLowerCase().trim()).filter(Boolean));
  let inter = 0;
  for (const t of A) if (B.has(t)) inter += 1;
  return inter;
};

const currentTags = (post.data.tags ?? []).map(String);
const currentTopics = (post.data.topics ?? []).map(String);

const relatedPosts = sortedPosts
  .filter((p) => p.slug !== post.slug)
  .map((p) => {
    const score =
      overlapScore(currentTags, (p.data.tags ?? []).map(String)) +
      overlapScore(currentTopics, (p.data.topics ?? []).map(String));
    return { post: p, score };
  })
  .filter((x) => x.score > 0)
  .sort((a, b) => b.score - a.score || b.post.data.pubDate.valueOf() - a.post.data.pubDate.valueOf())
  .slice(0, 3)
  .map((x) => x.post);
---

<Layout title={post.data.title} description={post.data.description} image={post.data.image}>
  <article class="min-h-screen bg-background">
    <div class="container max-w-[1100px] mx-auto px-4 sm:px-6 lg:px-8 py-10 sm:py-14 pb-16">
      <div class="grid grid-cols-1 lg:grid-cols-[1fr_240px] gap-10">
        <div class="rounded-2xl border border-white/10 bg-white/[0.03] shadow-sm px-6 sm:px-8 md:px-12 py-7 md:py-10">
          <Breadcrumb 
            items={[
              { label: 'Home', href: '/' },
              { label: 'Insights', href: '/blog' },
              { label: post.data.title }
            ]}
          />

          <div class="mb-8">
            <h1 class="type-h1 mb-4 text-white/95">{post.data.title}</h1>
            <p class="text-sm text-white/60 mb-3">
              {formattedDate} • {rt.label}
              {formattedUpdated ? ` • Updated ${formattedUpdated}` : ''}
            </p>

            {(post.data.tags?.length || post.data.topics?.length) ? (
              <div class="mb-6 flex flex-wrap gap-2">
                {(post.data.tags ?? []).map((t) => (
                  <a
                    href={`/blog/tags/${tagToSlug(String(t))}`}
                    class="inline-flex items-center rounded-full border border-white/10 bg-white/[0.03] px-3 py-1 text-xs font-semibold text-white/70 hover:bg-white/[0.06] hover:text-white transition-colors"
                  >
                    {t}
                  </a>
                ))}
              </div>
            ) : null}
            <ShareButtons title={post.data.title} />
          </div>

          <div class="prose max-w-none">
            <Content />
          </div>

          {relatedPosts.length > 0 ? (
            <div class="mt-10 pt-8 border-t border-white/10">
              <div class="text-xs tracking-[0.22em] uppercase text-white/50">Keep reading</div>
              <h2 class="mt-2 text-lg sm:text-xl font-semibold text-white/92">Related posts</h2>
              <div class="mt-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                {relatedPosts.map((p) => (
                  <BlogCard
                    title={p.data.title}
                    excerpt={p.data.description}
                    date={p.data.pubDate}
                    image={p.data.image}
                    slug={p.slug}
                    readingTime={readingTime(p.body).label}
                  />
                ))}
              </div>
            </div>
          ) : null}


          <div class="mt-10 pt-8 border-t border-white/10">
            <div class="text-xs tracking-[0.22em] uppercase text-white/50">Newsletter</div>
            <h2 class="mt-2 text-lg sm:text-xl font-semibold text-white/92">
              Get occasional product + AI notes
            </h2>
            <p class="mt-2 text-sm text-white/70 leading-[1.65]">
              1–2 emails/month. Practical ideas on building, shipping, and using AI well.
            </p>
            <div class="mt-5">
              <NewsletterForm />
            </div>
          </div>
        </div>

        <aside class="hidden lg:block">
          <div class="sticky top-32 h-fit max-h-[calc(100vh-8rem)] overflow-y-auto">
            <div class="space-y-6">
              <TableOfContents content={post.body} />
            </div>
          </div>
        </aside>
      </div>
    </div>
  </article>
</Layout>

<style is:global>
  /* Dark-first prose styles for insight pages */
  .prose {
    @apply text-base leading-7 text-white/85;
  }

  .prose h2 {
    @apply text-2xl font-semibold mt-12 mb-4 scroll-mt-32 text-white/95;
  }

  .prose h3 {
    @apply text-xl font-semibold mt-8 mb-3 scroll-mt-32 text-white/90;
  }

  .prose p {
    @apply mb-6 text-white/75;
  }

  .prose a {
    color: hsl(var(--primary));
    @apply underline decoration-2 underline-offset-2 transition-all;
    text-decoration-color: hsl(var(--primary) / 0.35);
  }

  .prose a:hover {
    text-decoration-color: hsl(var(--primary) / 0.95);
  }

  .prose strong {
    @apply text-white/95 font-semibold;
  }

  .prose img {
    @apply rounded-xl my-12;
  }

  .prose pre {
    @apply bg-black/30 border border-white/10 rounded-xl p-6 my-8 overflow-x-auto;
  }

  .prose code {
    @apply text-sm text-white/90;
  }
</style>

<script>
  // TOC active link highlighting (blog detail) — ViewTransitions-safe
  const initActiveToc = () => {
    const tocLinks = Array.from(document.querySelectorAll('.toc-link')) as HTMLAnchorElement[];
    const headings = Array.from(document.querySelectorAll('.prose h2, .prose h3')) as HTMLElement[];
    if (!tocLinks.length || !headings.length) return;

    const updateActive = () => {
      let activeHeading: HTMLElement | null = null;
      for (const heading of headings) {
        const rect = heading.getBoundingClientRect();
        if (rect.top <= 140) activeHeading = heading;
      }

      tocLinks.forEach((link) => link.classList.remove('active'));
      if (activeHeading?.id) {
        const activeLink = document.querySelector(`a[href="#${activeHeading.id}"]`);
        if (activeLink) activeLink.classList.add('active');
      }
    };

    const onScroll = (() => {
      let ticking = false;
      return () => {
        if (ticking) return;
        ticking = true;
        requestAnimationFrame(() => {
          updateActive();
          ticking = false;
        });
      };
    })();

    const w = window as any;
    if (w.__blogTocOnScroll) window.removeEventListener('scroll', w.__blogTocOnScroll);
    w.__blogTocOnScroll = onScroll;
    window.addEventListener('scroll', onScroll, { passive: true });

    updateActive();
  };

  initActiveToc();
  document.addEventListener('astro:page-load', initActiveToc);
</script>
