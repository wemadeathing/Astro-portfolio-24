---
import { getCollection, getEntry } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import ShareButtons from '../../components/ShareButtons.astro';
import TableOfContents from '../../components/TableOfContents.astro';
import Breadcrumb from '../../components/Breadcrumb.astro';
import NewsletterForm from '../../components/NewsletterForm.astro';
import BlogCard from '../../components/BlogCard.astro';
import { readingTime } from '../../lib/reading-time';
import { tagToSlug } from '../../lib/tag-utils';
import type { CollectionEntry } from 'astro:content';

export const prerender = true;

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

// For server-side rendering, get the post by slug
const { slug } = Astro.params;
let post: CollectionEntry<'blog'>;

if (Astro.props?.post) {
  // Static generation - use props
  post = Astro.props.post;
} else {
  // Server-side rendering - fetch by slug
  const postEntry = await getEntry('blog', slug!);
  if (!postEntry) {
    return Astro.redirect('/404');
  }
  post = postEntry;
}

const { Content } = await post.render();

const rt = readingTime(post.body);

const formattedDate = post.data.pubDate.toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});

const formattedUpdated = post.data.updatedDate
  ? post.data.updatedDate.toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
    })
  : null;

const allPosts = await getCollection('blog');
const sortedPosts = allPosts.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());
const currentIndex = sortedPosts.findIndex((p) => p.slug === post.slug);
const prevPost = currentIndex > 0 ? sortedPosts[currentIndex - 1] : null;
const nextPost = currentIndex >= 0 && currentIndex < sortedPosts.length - 1 ? sortedPosts[currentIndex + 1] : null;

const overlapScore = (a: string[], b: string[]) => {
  const A = new Set(a.map((x) => String(x).toLowerCase().trim()).filter(Boolean));
  const B = new Set(b.map((x) => String(x).toLowerCase().trim()).filter(Boolean));
  let inter = 0;
  for (const t of A) if (B.has(t)) inter += 1;
  return inter;
};

const currentTags = (post.data.tags ?? []).map(String);
const currentTopics = (post.data.topics ?? []).map(String);

const relatedPosts = sortedPosts
  .filter((p) => p.slug !== post.slug)
  .map((p) => {
    const score =
      overlapScore(currentTags, (p.data.tags ?? []).map(String)) +
      overlapScore(currentTopics, (p.data.topics ?? []).map(String));
    return { post: p, score };
  })
  .filter((x) => x.score > 0)
  .sort((a, b) => b.score - a.score || b.post.data.pubDate.valueOf() - a.post.data.pubDate.valueOf())
  .slice(0, 3)
  .map((x) => ({
    post: x.post,
    readingLabel: readingTime(x.post.body).label,
  }));
---

<Layout title={post.data.title} description={post.data.description} image={post.data.image}>
  <article class="min-h-screen">
    <div class="container max-w-[1100px] mx-auto px-4 sm:px-6 lg:px-8 py-10 sm:py-14 pb-16">
      {/* Mobile back to feed */}
      <div class="mb-4 sm:mb-6 lg:hidden">
        <a
          href="/blog"
          class="inline-flex items-center gap-2 rounded-full border border-white/10 bg-white/[0.03] px-3 py-1.5 text-xs font-semibold text-white/80 hover:bg-white/[0.06] hover:text-white focus:outline-none focus-visible:ring-4 focus-visible:ring-primary/20"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            aria-hidden="true"
          >
            <path d="m15 18-6-6 6-6" />
          </svg>
          <span>Back to Insights</span>
        </a>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-[1fr_240px] gap-10">
        <div class="rounded-[26px] border border-white/12 bg-white/[0.03] px-6 sm:px-8 md:px-12 py-6 md:py-10">
          <div class="hidden sm:block">
            <Breadcrumb
              items={[
                { label: 'Home', href: '/' },
                { label: 'Insights', href: '/blog' },
                { label: post.data.title }
              ]}
            />
          </div>

          <div class="mb-8">
            <h1 class="type-h1 mb-4 text-white/95">{post.data.title}</h1>
            <p class="text-sm text-white/60 mb-3">
              {formattedDate} • {rt.label}
              {formattedUpdated ? ` • Updated ${formattedUpdated}` : ''}
            </p>

            {(post.data.tags?.length || post.data.topics?.length) ? (
              <div class="mb-6 hidden sm:flex flex-wrap gap-2">
                {(post.data.tags ?? []).map((t) => (
                  <a
                    href={`/blog/tags/${tagToSlug(String(t))}`}
                    class="inline-flex items-center rounded-full border border-white/10 bg-white/[0.03] px-3 py-1 text-xs font-semibold text-white/70 hover:bg-white/[0.06] hover:text-white transition-colors"
                  >
                    {t}
                  </a>
                ))}
              </div>
            ) : null}

            <div class="mt-4 hidden sm:block">
              <ShareButtons title={post.data.title} />
            </div>
          </div>

          <div class="prose max-w-none">
            <Content />
          </div>

          {relatedPosts.length > 0 ? (
            <div class="mt-10 pt-8 border-t border-white/10">
              <div class="text-xs tracking-[0.22em] uppercase text-white/50">Keep reading</div>
              <h2 class="mt-2 text-lg sm:text-xl font-semibold text-white/92">Related posts</h2>
              <div class="mt-6">
                <div
                  class="keep-reading-row flex gap-3 overflow-x-auto pb-2 pl-1 pr-0 snap-x snap-proximity"
                  role="list"
                  aria-label="Related posts"
                >
                  {relatedPosts.map((item) => (
                    <a
                      role="listitem"
                      href={`/blog/${item.post.slug}`}
                      class="group w-56 sm:w-60 md:w-64 flex-shrink-0 snap-start rounded-[26px] overflow-hidden border border-white/12 bg-[#070910] transition-transform duration-200 hover:-translate-y-0.5 focus:outline-none focus-visible:ring-4 focus-visible:ring-primary/30 first:ml-1"
                    >
                      <div class="aspect-[16/11] overflow-hidden">
                        <img
                          src={item.post.data.image}
                          alt={item.post.data.title}
                          loading="lazy"
                          decoding="async"
                          class="h-full w-full object-cover"
                        />
                      </div>
                      <div class="p-4">
                        <h3 class="text-sm font-semibold text-white/95 leading-snug line-clamp-3">
                          {item.post.data.title}
                        </h3>
                        <p class="mt-2 text-xs text-white/60">
                          {new Intl.DateTimeFormat('en-US', { month: 'short', day: 'numeric', year: 'numeric' }).format(
                            item.post.data.pubDate
                          )}
                          {` • ${item.readingLabel}`}
                        </p>
                      </div>
                    </a>
                  ))}
                </div>
              </div>
            </div>
          ) : null}


          <div class="mt-10 pt-8 border-t border-transparent sm:border-white/10">
            <div class="text-xs tracking-[0.22em] uppercase text-white/50">Newsletter</div>
            <h2 class="mt-2 text-lg sm:text-xl font-semibold text-white/92">
              Get occasional product + AI notes
            </h2>
            <p class="mt-2 text-sm text-white/70 leading-[1.65]">
              1–2 emails/month. Practical ideas on building, shipping, and using AI well.
            </p>
            <div class="mt-5">
              <NewsletterForm />
            </div>
          </div>
        </div>

        <aside class="hidden lg:block">
          <div class="sticky top-32 h-fit max-h-[calc(100vh-8rem)] overflow-y-auto">
            <div class="space-y-6">
              <TableOfContents content={post.body} />
            </div>
          </div>
        </aside>
      </div>
    </div>
  </article>
</Layout>

<style is:global>
  /* Dark-first prose styles for insight pages */
  .prose {
    @apply text-base leading-7 text-white/85;
  }

  .prose h2 {
    @apply text-2xl font-semibold mt-12 mb-4 scroll-mt-32 text-white/95;
  }

  .prose h3 {
    @apply text-xl font-semibold mt-8 mb-3 scroll-mt-32 text-white/90;
  }

  .prose p {
    @apply mb-6 text-white/75;
  }

  .prose a {
    color: hsl(var(--primary));
    @apply underline decoration-2 underline-offset-2 transition-all;
    text-decoration-color: hsl(var(--primary) / 0.35);
  }

  .prose a:hover {
    text-decoration-color: hsl(var(--primary) / 0.95);
  }

  .prose strong {
    @apply text-white/95 font-semibold;
  }

  .prose img {
    @apply rounded-xl my-12;
  }

  .prose pre {
    @apply bg-black/30 border border-white/10 rounded-xl p-6 my-8 overflow-x-auto;
  }

  .prose code {
    @apply text-sm text-white/90;
  }

  .keep-reading-row {
    scrollbar-width: none;
    -ms-overflow-style: none;
  }

  .keep-reading-row::-webkit-scrollbar {
    display: none;
  }
</style>

<script>
  // TOC active link highlighting (blog detail) - ViewTransitions-safe
  const initActiveToc = () => {
    const tocLinks = Array.from(document.querySelectorAll('.toc-link')) as HTMLAnchorElement[];
    const headings = Array.from(document.querySelectorAll('.prose h2, .prose h3')) as HTMLElement[];
    if (!tocLinks.length || !headings.length) return;

    const updateActive = () => {
      let activeHeading: HTMLElement | null = null;
      for (const heading of headings) {
        const rect = heading.getBoundingClientRect();
        if (rect.top <= 140) activeHeading = heading;
      }

      tocLinks.forEach((link) => link.classList.remove('active'));
      if (activeHeading?.id) {
        const activeLink = document.querySelector(`a[href="#${activeHeading.id}"]`);
        if (activeLink) activeLink.classList.add('active');
      }
    };

    const onScroll = (() => {
      let ticking = false;
      return () => {
        if (ticking) return;
        ticking = true;
        requestAnimationFrame(() => {
          updateActive();
          ticking = false;
        });
      };
    })();

    const w = window as any;
    if (w.__blogTocOnScroll) window.removeEventListener('scroll', w.__blogTocOnScroll);
    w.__blogTocOnScroll = onScroll;
    window.addEventListener('scroll', onScroll, { passive: true });

    updateActive();
  };

  initActiveToc();
  document.addEventListener('astro:page-load', initActiveToc);
</script>
