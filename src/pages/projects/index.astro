---
import Layout from '../../layouts/Layout.astro';
import { getCollection } from 'astro:content';

const activeTag = Astro.url.searchParams.get('tag');

// Only get published projects
const allProjects = await getCollection('projects');
const projects = allProjects.filter((project) => project.data.published !== false);

const tagCounts = projects
  .flatMap((p) => p.data.tags ?? [])
  .map((t) => String(t).trim())
  .filter(Boolean)
  .reduce((acc, tag) => {
    acc.set(tag, (acc.get(tag) ?? 0) + 1);
    return acc;
  }, new Map<string, number>());

const topTags = Array.from(tagCounts.entries())
  .sort((a, b) => {
    // higher count first, then alpha
    if (b[1] !== a[1]) return b[1] - a[1];
    return a[0].localeCompare(b[0]);
  })
  .slice(0, 8)
  .map(([tag]) => tag);

// Keep current filter visible even if it's not in the top list.
const visibleTags = activeTag && !topTags.includes(activeTag) ? [activeTag, ...topTags] : topTags;

const filteredProjects = activeTag
  ? projects.filter((p) => (p.data.tags ?? []).includes(activeTag))
  : projects;

const buildTagHref = (tag: string | null) => {
  const url = new URL(Astro.url);
  if (!tag) url.searchParams.delete('tag');
  else url.searchParams.set('tag', tag);
  return `${url.pathname}${url.search}`;
};
---

<Layout 
  title="Projects | Enterprise Design Systems & AI-Powered Products"
  description="Portfolio of enterprise design systems, AI-powered applications, and rapid prototypes. Case studies featuring fintech platforms, WhatsApp Flow builders, and production SaaS products."
>
  <section class="py-10 sm:py-14">
    <div class="container max-w-[1100px] mx-auto px-4 sm:px-6 lg:px-8">
      <div class="max-w-[68ch]">
        <h1 class="type-h1 text-white/95">Work</h1>
        <p class="mt-4 type-lead text-white/70">
          Selected projects across design systems, rapid prototyping, and practical AI integration.
        </p>
      </div>

      {visibleTags.length > 0 && (
        <div class="mt-7">
          <div class="relative">
            <div class="project-tag-row flex flex-wrap items-center gap-2 overflow-x-auto pb-1">
            <a
              href={buildTagHref(null)}
              class:list={[
                'inline-flex items-center rounded-full border px-3 py-1.5 text-xs font-semibold transition-colors',
                !activeTag
                  ? 'bg-primary/15 text-white/90 border-primary/30'
                  : 'bg-white/[0.03] text-white/70 border-white/10 hover:bg-white/[0.06] hover:text-white',
              ]}
              aria-current={!activeTag ? 'true' : undefined}
            >
              All
            </a>
            {visibleTags.map((tag) => {
              const isActive = activeTag === tag;
              return (
                <a
                  href={buildTagHref(tag)}
                  class:list={[
                    'inline-flex items-center rounded-full border px-3 py-1.5 text-xs font-semibold transition-colors',
                    isActive
                      ? 'bg-primary/15 text-white/90 border-primary/30'
                      : 'bg-white/[0.03] text-white/70 border-white/10 hover:bg-white/[0.06] hover:text-white',
                  ]}
                  aria-current={isActive ? 'true' : undefined}
                  title={`Filter by ${tag}`}
                >
                  {tag}
                </a>
              );
            })}
            </div>
            <!-- Gradient fade indicators -->
            <div class="pointer-events-none absolute inset-y-0 left-0 w-6 bg-gradient-to-r from-background to-transparent sm:hidden" aria-hidden="true" />
            <div class="pointer-events-none absolute inset-y-0 right-0 w-6 bg-gradient-to-l from-background to-transparent sm:hidden" aria-hidden="true" />
          </div>
        </div>
      )}

      <div class="mt-10 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8 md:gap-10 stagger-children">
        {filteredProjects.map((project) => (
          <a
            href={`/projects/${project.slug}`}
            class="group block rounded-2xl border border-white/10 bg-white/[0.03] overflow-hidden transition-all hover:bg-white/[0.05] hover:border-white/20 hover:-translate-y-0.5 focus:outline-none focus-visible:ring-4 focus-visible:ring-primary/20"
          >
            <div class="aspect-video overflow-hidden bg-white/5 relative">
              <div class="absolute inset-0 skeleton-image" aria-hidden="true"></div>
              <img
                src={project.data.image}
                alt={project.data.title}
                class="relative w-full h-full object-cover transition-transform duration-300 group-hover:scale-105"
                loading="lazy"
                onload="this.parentElement.querySelector('.skeleton-image').style.display='none'"
              />
            </div>
            <div class="p-5">
              <h2 class="text-base sm:text-lg font-semibold text-white/92 group-hover:text-primary transition-colors">
                {project.data.title}
              </h2>
              <p class="mt-2 text-sm text-white/70 line-clamp-2">
                {project.data.description}
              </p>
            </div>
          </a>
        ))}
      </div>
    </div>
  </section>
</Layout> 