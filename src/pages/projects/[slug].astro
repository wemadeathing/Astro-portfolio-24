---
import { getCollection, getEntry } from 'astro:content';
import type { CollectionEntry } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import TableOfContents from '../../components/TableOfContents.astro';

export const prerender = true;

export async function getStaticPaths() {
  const projects = await getCollection('projects');
  return projects.map((project) => ({
    params: { slug: project.slug },
    props: { project },
  }));
}

// For server-side rendering, get the project by slug
const { slug } = Astro.params;
let project: CollectionEntry<'projects'>;

if (Astro.props?.project) {
  // Static generation - use props
  project = Astro.props.project;
} else {
  // Server-side rendering - fetch by slug
  const projectEntry = await getEntry('projects', slug!);
  if (!projectEntry) {
    return Astro.redirect('/404');
  }
  project = projectEntry;
}

const { Content, headings } = await project.render();
---

<Layout title={project.data.title}>
  <article class="min-h-screen bg-background">
    <div class="container max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-32 pb-16">
      <div class="grid grid-cols-1 lg:grid-cols-[1fr_250px] gap-8">
        <!-- Main Content Area with Light Background -->
        <div class="bg-zinc-50 text-zinc-900 rounded-2xl shadow-sm p-8 md:p-12">
          <!-- Header Section -->
          <div class="mb-8">
            <h1 class="text-4xl font-bold mb-4 text-zinc-900">{project.data.title}</h1>
            <p class="text-xl text-zinc-600 mb-6">
              {project.data.description}
            </p>
            <div class="flex flex-wrap gap-2">
              {project.data.tags?.map((tag) => (
                <span class="px-3 py-1.5 bg-primary/30 text-zinc-900 rounded-full text-sm font-semibold border border-primary/40">
                  {tag}
                </span>
              ))}
            </div>
          </div>

          <!-- Featured Image -->
          {project.data.image && (
            <div class="rounded-xl overflow-hidden mb-12">
              <img
                src={project.data.image}
                alt={project.data.title}
                class="w-full aspect-video object-cover"
              />
            </div>
          )}
          
          <!-- Content -->
          <div class="prose prose-lg prose-zinc max-w-none">
            <Content />
          </div>
        </div>

        <!-- Sidebar -->
        <aside class="hidden lg:block">
          <div class="sticky top-32">
            <h2 class="text-lg font-semibold mb-4">On this page</h2>
            <ul class="space-y-1 text-sm">
              {headings.map((heading) => (
                <li>
                  <a 
                    href={`#${heading.slug}`}
                    class="toc-link text-muted-foreground hover:text-primary"
                    style={`margin-left: ${(heading.depth - 1) * 1}rem`}
                  >
                    {heading.text}
                  </a>
                </li>
              ))}
            </ul>
          </div>
        </aside>
      </div>
    </div>
  </article>
</Layout>

<style is:global>
  /* Light mode prose styles for project pages */
  .prose {
    @apply text-lg leading-relaxed text-zinc-900;
  }

  .prose h2 {
    @apply text-2xl font-semibold mt-12 mb-4 scroll-mt-32 text-zinc-900;
  }
  
  .prose h3 {
    @apply text-xl font-semibold mt-8 mb-3 scroll-mt-32 text-zinc-900;
  }
  
  .prose h4 {
    @apply text-base font-medium text-zinc-700 scroll-mt-32;
  }

  .prose p {
    @apply mb-6 text-zinc-700;
  }

  .prose ul {
    @apply my-6 list-none space-y-2;
  }

  .prose ul li {
    @apply flex items-start text-zinc-700;
  }

  .prose ul li::before {
    content: "â€¢";
    @apply mr-3 text-zinc-900 font-bold text-lg;
  }

  .prose img {
    @apply rounded-xl my-12;
  }
  
  .prose figure {
    @apply my-12;
  }
  
  .prose figure img {
    @apply my-0;
  }
  
  .prose figcaption {
    @apply text-sm text-zinc-600 text-center mt-4 italic;
  }

  .prose blockquote {
    @apply border-l-4 border-primary/50 pl-6 my-8 italic text-zinc-600;
  }

  .prose pre {
    @apply bg-zinc-100 border border-zinc-200 rounded-xl p-6 my-8;
  }

  .prose code {
    @apply text-sm text-zinc-900;
  }

  .prose a {
    color: hsl(84 82% 25%);
    @apply underline decoration-2 underline-offset-2 transition-all;
    text-decoration-color: hsl(84 82% 25% / 0.3);
  }

  .prose a:hover {
    text-decoration-color: hsl(84 82% 25%);
  }

  .prose strong {
    @apply text-zinc-900 font-semibold;
  }

  /* Smooth scroll for table of contents */
  html {
    scroll-behavior: smooth;
  }

  /* Enhanced TOC styling */
  .toc-link {
    display: block;
    padding: 0.375rem 0.75rem;
    border-radius: 0.375rem;
    transition: all 0.2s ease-in-out;
    position: relative;
  }

  .toc-link:hover {
    background-color: hsl(var(--primary) / 0.1);
    transform: translateX(4px);
  }

  .toc-link.active {
    background-color: hsl(var(--primary) / 0.15);
    color: hsl(var(--primary));
    font-weight: 500;
  }
</style>

<script>
  // Enhanced smooth scroll and active link highlighting
  document.addEventListener('DOMContentLoaded', function() {
    const tocLinks = document.querySelectorAll('.toc-link');
    const headings = document.querySelectorAll('.prose h2, .prose h3');
    
    // Add smooth scroll behavior to TOC links
    tocLinks.forEach(link => {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        const targetId = this.getAttribute('href')?.slice(1);
        const targetElement = document.getElementById(targetId!);
        
        if (targetElement) {
          // Add a subtle loading state
          this.style.opacity = '0.7';
          
          targetElement.scrollIntoView({ 
            behavior: 'smooth',
            block: 'start'
          });
          
          // Reset opacity after scroll
          setTimeout(() => {
            this.style.opacity = '1';
          }, 600);
        }
      });
    });

    // Highlight active section in TOC
    function updateActiveToc() {
      let activeHeading = null;
      
      headings.forEach(heading => {
        const rect = heading.getBoundingClientRect();
        if (rect.top <= 100 && rect.bottom >= 0) {
          activeHeading = heading;
        }
      });
      
      // Remove all active classes
      tocLinks.forEach(link => link.classList.remove('active'));
      
      // Add active class to current section
      if (activeHeading) {
        const activeLink = document.querySelector(`a[href="#${activeHeading.id}"]`);
        if (activeLink) {
          activeLink.classList.add('active');
        }
      }
    }

    // Update active TOC on scroll
    let ticking = false;
    window.addEventListener('scroll', function() {
      if (!ticking) {
        requestAnimationFrame(function() {
          updateActiveToc();
          ticking = false;
        });
        ticking = true;
      }
    });

    // Initial call
    updateActiveToc();
  });
</script>