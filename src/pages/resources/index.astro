---
import Layout from '../../layouts/Layout.astro';
import ResourceCard from '../../components/resources/ResourceCard.astro';
import { getCollection } from 'astro:content';
import { getResourceMeta } from '../../lib/resource-meta';

export const prerender = true;

const normalizeType = (t: unknown) => String(t || '').toLowerCase().trim();

const typeSortOrder: Record<string, number> = {
  docs: 1,
  library: 2,
  tool: 3,
  directory: 4,
  platform: 5,
  article: 6,
  video: 7,
  template: 8,
  course: 9,
  podcast: 10,
  newsletter: 11,
  book: 12,
  other: 99,
};

const resources = await getCollection('resources');

const sorted = resources
  .slice()
  .sort((a, b) => {
    const af = Number(Boolean(a.data.featured));
    const bf = Number(Boolean(b.data.featured));
    if (bf !== af) return bf - af;

    const at = normalizeType(a.data.type || 'other');
    const bt = normalizeType(b.data.type || 'other');
    const ao = typeSortOrder[at] ?? 99;
    const bo = typeSortOrder[bt] ?? 99;
    if (ao !== bo) return ao - bo;

    const ad = a.data.addedDate ? a.data.addedDate.valueOf() : 0;
    const bd = b.data.addedDate ? b.data.addedDate.valueOf() : 0;
    return bd - ad;
  });

// Define curated filter categories
const filterCategories = [
  { label: 'All', value: '' },
  { label: 'AI Builders', value: 'ai-builder' },
  { label: 'Backend', value: 'backend' },
  { label: 'Frameworks', value: 'framework' },
  { label: 'UI Components', value: 'ui' },
  { label: 'Typography', value: 'typography' },
  { label: 'Colors', value: 'colors' },
  { label: 'Animation', value: 'animation' },
  { label: 'Illustrations', value: 'illustrations' },
  { label: 'Icons', value: 'icons' },
  { label: 'Accessibility', value: 'accessibility' },
  { label: 'Inspiration', value: 'inspiration' },
  { label: 'Docs', value: 'docs' },
];

const totalCount = sorted.length;

// Fetch metadata for ALL resources
const cards = await Promise.all(
  sorted.map(async (r) => {
    const meta = await getResourceMeta(r.data.url);
    
    const title = r.data.title || meta.title || r.data.url;
    const description = r.data.description || meta.description;
    const image = r.data.image || meta.image;
    const siteName = meta.siteName;
    const tags = r.data.tags || [];

    return {
      href: r.data.url,
      title,
      description,
      image,
      siteName,
      type: normalizeType(r.data.type || 'other'),
      tags,
      search: `${title} ${description ?? ''} ${siteName ?? ''} ${r.data.url}`.toLowerCase()
    };
  })
);
---

<Layout
  title="Resources | Tools, videos, and links for designers who ship"
  description="Curated resources: tools, videos, articles, and templates for designers and builders working in AI and product." 
>
  <section class="py-10 sm:py-14">
    <div class="container max-w-[1100px] mx-auto px-4 sm:px-6 lg:px-8">
      <div class="max-w-[68ch]">
        <h1 class="type-h1 text-white/95">Resources</h1>
        <p class="mt-4 type-lead text-white/70">
          Curated resources: tools, videos, and articles I actually use.
        </p>
      </div>

      <!-- Filter UI -->
      <div class="mt-8 space-y-4">
        <!-- Search -->
        <div class="relative">
          <label for="resource-search" class="sr-only">Search resources</label>
          <input
            type="text"
            id="resource-search"
            placeholder="Search resources..."
            class="w-full max-w-md px-4 py-2.5 pl-10 pr-12 rounded-xl bg-white/5 border border-white/10 text-white placeholder:text-white/40 focus:outline-none focus:border-primary/50 focus:ring-2 focus:ring-primary/20 transition-all"
          />
          <span class="absolute right-3 top-1/2 -translate-y-1/2 kbd pointer-events-none" id="search-kbd-hint">/</span>
          <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-white/40 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
        </div>
        
        <!-- Category chips - horizontal scroll on mobile, wrap on desktop -->
        <div class="flex gap-2 overflow-x-auto md:flex-wrap pb-2 md:pb-0 scrollbar-hide" id="category-filters">
          {filterCategories.map((cat, idx) => (
            <button
              type="button"
              data-category={cat.value}
              aria-pressed={idx === 0 ? "true" : "false"}
              class:list={[
                "filter-chip shrink-0 px-3 py-1.5 rounded-full text-xs font-medium border transition-all focus:outline-none focus-visible:ring-2 focus-visible:ring-primary/50",
                idx === 0 
                  ? "bg-primary/20 border-primary/40 text-primary" 
                  : "bg-white/5 border-white/10 text-white/70 hover:bg-white/10 hover:border-white/20"
              ]}
            >
              {cat.label}
            </button>
          ))}
        </div>
      </div>

      <!-- Results info bar -->
      <div class="mt-6 flex items-center justify-between text-sm" id="results-bar">
        <span class="text-white/50" id="results-count">
          Showing <span class="text-white/80 font-medium" data-count>{totalCount}</span> of {totalCount} resources
        </span>
        <button
          type="button"
          id="clear-filters"
          class="hidden items-center gap-1.5 text-white/50 hover:text-white transition-colors"
        >
          <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
          Clear filters
        </button>
      </div>

      <style>
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Card animations */
        [data-resource-card] {
          transition: opacity 0.2s ease, transform 0.25s ease;
        }
        [data-resource-card].hiding {
          opacity: 0;
          transform: scale(0.95);
        }
        [data-resource-card].hidden {
          display: none;
        }
        [data-resource-card].showing {
          animation: cardFadeIn 0.25s ease forwards;
        }
        @keyframes cardFadeIn {
          from { opacity: 0; transform: scale(0.95); }
          to { opacity: 1; transform: scale(1); }
        }
        
        /* Staggered entrance on page load */
        [data-resource-card] {
          opacity: 0;
          animation: cardEntrance 0.4s ease forwards;
        }
        @keyframes cardEntrance {
          from { opacity: 0; transform: translateY(12px); }
          to { opacity: 1; transform: translateY(0); }
        }
        
        /* Keyboard hint */
        .kbd {
          display: inline-flex;
          align-items: center;
          justify-content: center;
          min-width: 1.25rem;
          height: 1.25rem;
          padding: 0 0.25rem;
          font-size: 0.65rem;
          font-family: ui-monospace, monospace;
          background: rgba(255,255,255,0.08);
          border: 1px solid rgba(255,255,255,0.15);
          border-radius: 4px;
          color: rgba(255,255,255,0.5);
        }
      </style>

      <div class="mt-4">
        <div
          class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6"
          data-resource-list
        >
          {cards.map((c, i) => (
            <ResourceCard
              href={c.href}
              title={c.title}
              description={c.description}
              image={c.image}
              siteName={c.siteName}
              type={c.type}
              tags={c.tags}
              index={i}
            />
          ))}
        </div>

        <div
          class="hidden mt-10 rounded-2xl border border-white/10 bg-white/[0.03] p-6 text-center"
          data-resource-empty
        >
          <p class="text-white/70 mb-4">No resources found.</p>
          <button
            type="button"
            class="clear-all-btn text-sm text-primary hover:text-primary/80 transition-colors"
          >
            Clear filters
          </button>
        </div>

        {cards.length === 0 && (
          <div class="mt-10 rounded-2xl border border-white/10 bg-white/[0.03] p-6 text-white/70">
            No resources yet.
          </div>
        )}
      </div>

      <script is:inline define:vars={{ totalCount }}>
        (() => {
          const searchInput = document.getElementById('resource-search');
          const categoryFilters = document.getElementById('category-filters');
          const clearBtn = document.getElementById('clear-filters');
          const resultsCount = document.querySelector('[data-count]');
          const empty = document.querySelector('[data-resource-empty]');
          const clearAllBtns = document.querySelectorAll('.clear-all-btn');
          const kbdHint = document.getElementById('search-kbd-hint');

          let currentQuery = '';
          let currentCategory = '';
          let filterTimeout = null;
          
          const updateChipStyles = () => {
            const chips = categoryFilters.querySelectorAll('.filter-chip');
            chips.forEach(chip => {
              const isActive = chip.getAttribute('data-category') === currentCategory;
              chip.setAttribute('aria-pressed', isActive ? 'true' : 'false');
              if (isActive) {
                chip.className = 'filter-chip shrink-0 px-3 py-1.5 rounded-full text-xs font-medium border transition-all focus:outline-none focus-visible:ring-2 focus-visible:ring-primary/50 bg-primary/20 border-primary/40 text-primary';
              } else {
                chip.className = 'filter-chip shrink-0 px-3 py-1.5 rounded-full text-xs font-medium border transition-all focus:outline-none focus-visible:ring-2 focus-visible:ring-primary/50 bg-white/5 border-white/10 text-white/70 hover:bg-white/10 hover:border-white/20';
              }
            });
          };

          const updateURL = () => {
            const url = new URL(window.location.href);
            if (currentQuery) {
              url.searchParams.set('q', currentQuery);
            } else {
              url.searchParams.delete('q');
            }
            if (currentCategory) {
              url.searchParams.set('cat', currentCategory);
            } else {
              url.searchParams.delete('cat');
            }
            history.replaceState({}, '', url.toString());
          };

          const updateClearButton = () => {
            const hasFilters = currentQuery || currentCategory;
            clearBtn.classList.toggle('hidden', !hasFilters);
            clearBtn.classList.toggle('inline-flex', hasFilters);
          };
          
          const applyFilter = () => {
            const q = currentQuery.toLowerCase().trim();
            const cat = currentCategory.toLowerCase();
            const cards = Array.from(document.querySelectorAll('[data-resource-card]'));
            let shown = 0;
            
            // Clear any pending animation timeout
            if (filterTimeout) clearTimeout(filterTimeout);

            const toHide = [];
            const toShow = [];

            for (const el of cards) {
              const searchText = (el.getAttribute('data-search') || '').toLowerCase();
              const cardTags = (el.getAttribute('data-tags') || '').toLowerCase().split(',');
              const cardType = (el.getAttribute('data-type') || '').toLowerCase();
              
              // Text search matches against search text
              const matchesQuery = !q || searchText.includes(q);
              
              // Category uses exact tag matching
              let matchesCategory = !cat;
              if (cat) {
                // Check if category matches any tag or the type
                matchesCategory = cardTags.some(tag => tag.includes(cat)) || cardType.includes(cat);
              }
              
              const match = matchesQuery && matchesCategory;
              const isCurrentlyHidden = el.classList.contains('hidden');
              
              if (match) {
                shown += 1;
                if (isCurrentlyHidden) toShow.push(el);
              } else {
                if (!isCurrentlyHidden) toHide.push(el);
              }
            }

            // Animate out cards that should hide
            toHide.forEach(el => {
              el.classList.add('hiding');
            });

            // After hide animation, actually hide them and show new ones
            filterTimeout = setTimeout(() => {
              toHide.forEach(el => {
                el.classList.remove('hiding');
                el.classList.add('hidden');
              });
              
              // Show cards with staggered animation
              toShow.forEach((el, i) => {
                el.classList.remove('hidden');
                el.classList.add('showing');
                el.style.animationDelay = `${i * 30}ms`;
              });
              
              // Clean up showing class after animation
              setTimeout(() => {
                toShow.forEach(el => {
                  el.classList.remove('showing');
                  el.style.animationDelay = '';
                });
              }, 300 + toShow.length * 30);
            }, toHide.length > 0 ? 200 : 0);

            // Update count
            if (resultsCount) {
              resultsCount.textContent = shown.toString();
            }

            // Show/hide empty state
            if (empty) {
              empty.classList.toggle('hidden', shown !== 0);
            }

            updateClearButton();
            updateURL();
          };

          const clearFilters = () => {
            currentQuery = '';
            currentCategory = '';
            searchInput.value = '';
            updateChipStyles();
            applyFilter();
          };

          // Event listeners
          searchInput.addEventListener('input', (e) => {
            currentQuery = e.target.value;
            applyFilter();
          });

          // Escape key clears search
          searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
              searchInput.value = '';
              currentQuery = '';
              applyFilter();
              searchInput.blur();
            }
          });

          categoryFilters.addEventListener('click', (e) => {
            const chip = e.target.closest('.filter-chip');
            if (!chip) return;
            currentCategory = chip.getAttribute('data-category') || '';
            updateChipStyles();
            applyFilter();
          });

          clearBtn.addEventListener('click', clearFilters);
          clearAllBtns.forEach(btn => btn.addEventListener('click', clearFilters));

          // Global keyboard shortcuts
          document.addEventListener('keydown', (e) => {
            // "/" to focus search (when not in an input)
            if (e.key === '/' && document.activeElement !== searchInput && !e.ctrlKey && !e.metaKey) {
              e.preventDefault();
              searchInput.focus();
              searchInput.select();
            }
          });

          // Hide kbd hint when focused, show when blurred
          searchInput.addEventListener('focus', () => {
            if (kbdHint) kbdHint.style.opacity = '0';
          });
          searchInput.addEventListener('blur', () => {
            if (kbdHint && !searchInput.value) kbdHint.style.opacity = '1';
          });

          // Initialize from URL
          const init = () => {
            const p = new URLSearchParams(window.location.search);
            if (p.has('q')) {
              currentQuery = p.get('q') || '';
              searchInput.value = currentQuery;
            }
            if (p.has('cat')) {
              currentCategory = p.get('cat') || '';
              updateChipStyles();
            }
            applyFilter();
          };

          init();
          document.addEventListener('astro:page-load', init);
        })();
      </script>
    </div>
  </section>
</Layout>
